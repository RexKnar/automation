// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- User & Organization Management ---

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String? // Nullable if using OAuth only
  name         String?
  avatarUrl    String?
  role         GlobalRole @default(USER) // USER, SUPER_ADMIN
  
  emailVerified     DateTime?
  verificationToken String?
  referralCode      String?    @unique

  createdAt    DateTime   @default(now())

  memberships WorkspaceMember[]

  @@index([email])
}

model Workspace {
  id   String   @id @default(uuid())
  name String
  slug String   @unique // For URL routing
  plan PlanType @default(FREE) // FREE, PRO, ENTERPRISE

  // Billing (Razorpay)
  razorpaySubscriptionId String?
  razorpayCustomerId     String?

  members      WorkspaceMember[]
  roles        Role[]
  invitations  Invitation[]
  channels     Channel[]
  flows        Flow[]
  contacts     Contact[]
  tags         Tag[]
  customFields CustomField[]
  logs         AutomationLog[]
  deliveryLogs AutomationDeliveryLog[]
  payments     Payment[]

  planId      String?
  currentPlan Plan?   @relation(fields: [planId], references: [id])
  isActive    Boolean @default(true)
  referralCode String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkspaceMember {
  id          String        @id @default(uuid())
  userId      String
  workspaceId String
  role        WorkspaceRole @default(AGENT) // Kept for backward compatibility, mapped to System Roles
  roleId      String?       // Optional during migration

  assignedChannels Channel[] // Many-to-many relation for channel access control

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])
  userRole  Role?     @relation(fields: [roleId], references: [id])

  @@unique([userId, workspaceId])
  @@index([workspaceId])
}

model Role {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  permissions Json     @default("{}")
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace         @relation(fields: [workspaceId], references: [id])
  members   WorkspaceMember[]
  invitations Invitation[]

  @@unique([workspaceId, name])
}

model Invitation {
  id                 String   @id @default(uuid())
  email              String
  roleId             String
  workspaceId        String
  token              String   @unique
  status             String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED
  assignedChannelIds String[] // IDs of channels assigned to this invite
  expiresAt          DateTime
  createdAt          DateTime @default(now())

  role      Role      @relation(fields: [roleId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([token])
  @@index([email])
}

// --- Integration Layer (Omnichannel) ---

model Channel {
  id          String      @id @default(uuid())
  workspaceId String
  type        ChannelType // INSTAGRAM, WHATSAPP, EMAIL
  name        String // e.g. "Main Insta", "Support WhatsApp"

  // Provider specific config (Tokens, Page IDs, Phone Numbers, SMTP)
  // Encrypted at application layer
  config Json

  isActive Boolean @default(true)

  workspace       Workspace        @relation(fields: [workspaceId], references: [id])
  conversations   Conversation[]
  contactChannels ContactChannel[]
  assignedMembers WorkspaceMember[] // Many-to-many relation for channel access control
  flows           Flow[] // One-to-many relation: Channel has many Flows

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
}

// --- Automation Engine ---

model Flow {
  id          String      @id @default(uuid())
  workspaceId String
  channelId   String?     // Optional link to specific channel
  name        String
  channelType ChannelType // Limit flow to specific channel type
  triggerType TriggerType // KEYWORD, COMMENT, STORY_REPLY, WELCOME
  keywords    String[] // Array of keywords if triggerType is KEYWORD
  isActive    Boolean     @default(false)

  nodes Json // React Flow Nodes (UI State)
  edges Json // React Flow Edges (UI State)

  // Compiled logic for faster execution
  executionGraph Json?

  stats FlowStats?
  logs  AutomationLog[]
  deliveryLogs AutomationDeliveryLog[]

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  channel   Channel?  @relation(fields: [channelId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
  @@index([isActive])
}

model FlowStats {
  id        String @id @default(uuid())
  flowId    String @unique
  triggered Int    @default(0)
  completed Int    @default(0)
  clicks    Int    @default(0)

  flow Flow @relation(fields: [flowId], references: [id])
}

model AutomationLog {
  id          String   @id @default(uuid())
  flowId      String?
  workspaceId String?
  triggerType String
  status      String
  message     String?
  metadata    Json?
  createdAt   DateTime @default(now())

  workspace Workspace? @relation(fields: [workspaceId], references: [id])
  flow      Flow?      @relation(fields: [flowId], references: [id])

  @@index([workspaceId])
  @@index([flowId])
}

// --- CRM & Messaging ---

model Contact {
  id          String @id @default(uuid())
  workspaceId String

  // Unified Profile
  fullName      String?
  email         String?
  phone         String?
  profilePicUrl String?

  // Custom Data
  customData Json? // Key-value pairs for Custom Fields
  tags       ContactTag[]

  // Channels this contact is reachable on
  channels      ContactChannel[]
  conversations Conversation[]
  deliveryLogs  AutomationDeliveryLog[]

  lastInteractionAt DateTime @default(now())
  createdAt         DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId, email])
  @@index([workspaceId, phone])
  @@index([workspaceId, lastInteractionAt])
}

model ContactChannel {
  id        String @id @default(uuid())
  contactId String
  channelId String

  // The platform-specific ID (PSID for Insta, WAID for WhatsApp, Email for Email)
  externalId String

  // Channel specific metadata (e.g. "Can Message?", "Window Open?")
  metadata Json?

  contact Contact @relation(fields: [contactId], references: [id])
  channel Channel @relation(fields: [channelId], references: [id])

  @@unique([channelId, externalId]) // Unique user per channel
  @@index([contactId])
}

model Tag {
  id          String @id @default(uuid())
  workspaceId String
  name        String

  contacts  ContactTag[]
  workspace Workspace    @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, name])
}

model ContactTag {
  contactId  String
  tagId      String
  assignedAt DateTime @default(now())

  contact Contact @relation(fields: [contactId], references: [id])
  tag     Tag     @relation(fields: [tagId], references: [id])

  @@id([contactId, tagId])
}

model CustomField {
  id          String    @id @default(uuid())
  workspaceId String
  key         String
  name        String
  type        FieldType // TEXT, NUMBER, BOOLEAN, DATE

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, key])
}

model Conversation {
  id          String     @id @default(uuid())
  workspaceId String
  channelId   String
  contactId   String
  status      ConvStatus @default(OPEN) // OPEN, CLOSED, SNOOZED

  messages Message[]

  contact Contact @relation(fields: [contactId], references: [id])
  channel Channel @relation(fields: [channelId], references: [id])

  updatedAt DateTime @updatedAt // Sort by recent activity

  @@index([workspaceId, status])
  @@index([contactId])
  @@index([channelId])
}

model Message {
  id             String     @id @default(uuid())
  conversationId String
  sender         SenderType // USER, BOT, AGENT

  // Content
  contentType ContentType @default(TEXT) // TEXT, IMAGE, TEMPLATE
  content     String? // Text content or Template Name
  mediaUrl    String? // Image/Video URL

  // Platform Metadata
  externalId String? // Message ID from provider (deduplication)
  metadata   Json? // Template params, Quick replies, etc.

  createdAt DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId, createdAt])
}

// --- Enums ---

enum GlobalRole {
  USER
  SUPER_ADMIN
}

enum WorkspaceRole {
  OWNER
  ADMIN
  EDITOR
  AGENT
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum ChannelType {
  INSTAGRAM
  WHATSAPP
  EMAIL
}

enum TriggerType {
  KEYWORD
  COMMENT
  STORY_REPLY
  WELCOME
  DEFAULT_REPLY
  NEW_SUBSCRIBER // Email specific
}

enum FieldType {
  TEXT
  NUMBER
  BOOLEAN
  DATE
}

enum ConvStatus {
  OPEN
  CLOSED
  SNOOZED
}

enum SenderType {
  USER
  BOT
  AGENT
}

enum ContentType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  TEMPLATE // WhatsApp Templates
}

model AutomationDeliveryLog {
  id          String   @id @default(uuid())
  flowId      String
  contactId   String
  workspaceId String
  
  // Status Flags
  followMsgSent    Boolean @default(false)
  followMsgRead    Boolean @default(false) // If possible via webhooks
  followConfirmed  Boolean @default(false)
  
  openingMsgSent   Boolean @default(false)
  openingMsgRead   Boolean @default(false)
  openingClicked   Boolean @default(false) // "Send me the link" clicked
  
  emailReqSent     Boolean @default(false)
  emailProvided    Boolean @default(false)
  
  linkMsgSent      Boolean @default(false)
  linkMsgRead      Boolean @default(false)
  linkClicked      Boolean @default(false)
  
  followUpSent     Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  flow      Flow      @relation(fields: [flowId], references: [id])
  contact   Contact   @relation(fields: [contactId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([flowId, contactId])
}

// --- Super Admin Module ---

model AdminUser {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  name         String?
  role         AdminRole @default(SUPER_ADMIN)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Plan {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  prices    Json     @default("{}") // { "USD": 10, "INR": 800 }
  limits    Json     @default("{}")
  features  Json     @default("{}")
  isCustom  Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaces Workspace[]
}

model Payment {
  id          String   @id @default(uuid())
  workspaceId String
  amount      Decimal
  status      String // PENDING, COMPLETED, FAILED
  providerId  String? // Razorpay Order ID
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

model Referral {
  id           String   @id @default(uuid())
  referrerId   String   // User ID or Workspace ID
  refereeId    String   // User ID or Workspace ID
  code         String
  status       String   @default("PENDING") // PENDING, COMPLETED
  rewardStatus String   @default("PENDING") // PENDING, PAID
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([referrerId])
  @@index([refereeId])
  @@index([code])
}

model ReferralCode {
  id           String   @id @default(uuid())
  code         String   @unique
  referrerId   String   // User ID or Workspace ID
  type         String   @default("ALIAS") // ALIAS, CAMPAIGN
  isActive     Boolean  @default(true)
  usageCount   Int      @default(0)
  
  // Advanced Configuration
  rewardType          String   @default("FLAT") // FLAT, PERCENTAGE
  rewardAmount        Float    @default(0)
  eligiblePlans       String[] // Array of Plan IDs
  rewardTrigger       String   @default("FIRST_PURCHASE") // FIRST_PURCHASE, RECURRING
  renewalRewardType   String   @default("NONE") // FLAT, PERCENTAGE, NONE
  renewalRewardAmount Float    @default(0)
  maxUsage            Int?
  expiryDate          DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([referrerId])
  @@index([code])
}

enum AdminRole {
  SUPER_ADMIN
  PRODUCT_OWNER
  SUPPORT
  SALES
  RELATIONSHIP_MANAGER
}
